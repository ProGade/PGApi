/** ProGade API* Copyright 2012, Hans-Peter Wandura (ProGade)* Last changes of this file: Aug 22 2012*/var PG_NETWORK_TRANSACTION_INDEX_PARAMETERS = 0;var PG_NETWORK_TRANSACTION_INDEX_RESPONSE_FUNCTION = 1;var PG_NETWORK_TRANSACTION_INDEX_RESPONSE_XML_FILE = 2;var PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT = 3;var PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ERROR_FUNCTION = 4;var PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ABORT_FUNCTION = 5;var PG_NETWORK_TRANSACTION_INDEX_RESPONSE_UPLOAD_PROGRESS = 6;/*@start class@param extends classPG_ClassBasics*/function classPG_Network(){	// Declarations...	this.oAjax = null;	this.sAjaxResponseFile = 'xml.php';	// this.bAjaxPolling = false;	this.fOnResponse = null;	this.sParameters = '';	this.bUseWebSockets = false;	this.oWebSockets = null;	this.iMaxTransactionQueue = 100;	this.axTransactions = new Array();	// Construct...	this.setID('PGNetwork');	this.initClassBasics();	// Methods...	/*	@start method	@group Setup	@description	[en]...[/en]	@param sAjaxResponseFile [needed][type]string[/type]	[en]...[/en]	*/	this.setAjaxResponseXmlFile = function(_sAjaxResponseFile)	{		if (typeof(_sAjaxResponseFile) == 'undefined') {var _sAjaxResponseFile = null;}		_sAjaxResponseFile = this.getRealParameter({'oParameters': _sAjaxResponseFile, 'sName': 'sAjaxResponseFile', 'xParameter': _sAjaxResponseFile});		this.sAjaxResponseFile = _sAjaxResponseFile;	}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@return sAjaxResponseFile [type]string[/type]	[en]...[/en]	*/	this.getAjaxResponseXmlFile = function() {return this.sAjaxResponseFile;}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@param oWebSockets [needed][type]object[/type]	[en]...[/en]	*/	this.setWebSockets = function(_oWebSockets)	{		if (typeof(_oWebSockets) == 'undefined') {var _oWebSockets = null;}		_oWebSockets = this.getRealParameter({'oParameters': _oWebSockets, 'sName': 'oWebSockets', 'xParameter': _oWebSockets, 'bNotNull': true});		this.oWebSockets = _oWebSockets;	}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@return oWebSockets [type]object[/type]	[en]...[/en]	*/	this.getWebSockets = function() {return this.oWebSockets;}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@param bUse [needed][type]bUse[/type]	[en]...[/en]	*/	this.useWebSockets = function(_bUse)	{		if (typeof(_bUse) == 'undefined') {var _bUse = null;}		_bUse = this.getRealParameter({'oParameters': _bUse, 'sName': 'bUse', 'xParameter': _bUse});		this.bUseWebSockets = _bUse;	}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@return bUseWebSockets [type]bool[/type]	[en]...[/en]	*/	this.isWebSockets = function() {return this.bUseWebSockets;}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@return bIsSupported [type]bool[/type]	[en]...[/en]	*/	this.isWebSocketsSupported = function() {if (this.oWebSockets) {return this.oWebSockets.isSupported();} return false;}	/* @end method */	/*	@start method	@group Setup	@description	[en]...[/en]	@param bUseWebSockets [type]bool[/type]	[en]...[/en]	@param oAjax [type]object[/type]	[en]...[/en]	@param oWebSockets [type]object[/type]	[en]...[/en]	*/	this.init = function(_bUseWebSockets, _oAjax, _oWebSockets)	{		if (typeof(_bUseWebSockets) == 'undefined') {var _bUseWebSockets = null;}		if (typeof(_oAjax) == 'undefined') {var _oAjax = null;}		if (typeof(_oWebSockets) == 'undefined') {var _oWebSockets = null;}		_oAjax = this.getRealParameter({'oParameters': _bUseWebSockets, 'sName': 'oAjax', 'xParameter': _oAjax});		_oWebSockets = this.getRealParameter({'oParameters': _bUseWebSockets, 'sName': 'oWebSockets', 'xParameter': _oWebSockets});		_bUseWebSockets = this.getRealParameter({'oParameters': _bUseWebSockets, 'sName': 'bUseWebSockets', 'xParameter': _bUseWebSockets});		if (_bUseWebSockets == null) {_bUseWebSockets = false;}		if ((_oAjax == null) && (typeof(oPGAjax) != 'undefined')) {_oAjax = oPGAjax;}		if ((_oWebSockets == null) && (typeof(oPGWebSockets) != 'undefined')) {_oWebSockets = oPGWebSockets;}		this.bUseWebSockets = _bUseWebSockets;		this.oWebSockets = _oWebSockets;		this.oAjax = _oAjax;		if (this.oWebSockets != null)		{			if (this.bUseWebSockets == true)			{				if (this.oWebSockets.isSupported()) {this.bUseWebSockets = true;}				else {this.bUseWebSockets = false;}			}		}		else {this.bUseWebSockets = false;}	}	/* @end method */	/*	@start method	@description	[en]...[/en]	@return iTransactionIndex [type]int[/type]	[en]...[/en]	@param sParameters [type]string[/type]	[en]...[/en]	@param fOnResponse [type]function[/type]	[en]...[/en]	@param sResponseFile [type]string[/type]	[en]...[/en]	*/	this.registerTransaction = function(_sParameters, _fOnResponse, _sResponseFile, _fOnError, _fOnAbort, _fOnUploadProgress)	{		if (typeof(_sParameters) == 'undefined') {var _sParameters = null;}		if (typeof(_fOnResponse) == 'undefined') {var _fOnResponse = null;}		if (typeof(_sResponseFile) == 'undefined') {var _sResponseFile = null;}		if (typeof(_fOnError) == 'undefined') {var _fOnError = null;}		if (typeof(_fOnAbort) == 'undefined') {var _fOnAbort = null;}		if (typeof(_fOnUploadProgess) == 'undefined') {var _fOnUploadProgess = null;}		_fOnResponse = this.getRealParameter({'oParameters': _sParameters, 'sName': 'fOnResponse', 'xParameter': _fOnResponse});		_sResponseFile = this.getRealParameter({'oParameters': _sParameters, 'sName': 'sResponseFile', 'xParameter': _sResponseFile});		_fOnError = this.getRealParameter({'oParameters': _sParameters, 'sName': 'fOnError', 'xParameter': _fOnError});		_fOnAbort = this.getRealParameter({'oParameters': _sParameters, 'sName': 'fOnAbort', 'xParameter': _fOnAbort});		_fOnUploadProgress = this.getRealParameter({'oParameters': _sParameters, 'sName': 'fOnUploadProgress', 'xParameter': _fOnUploadProgress});		_sParameters = this.getRealParameter({'oParameters': _sParameters, 'sName': 'sParameters', 'xParameter': _sParameters});		if (_sParameters == null) {_sParameters = '';}		if (_fOnResponse == null) {_fOnResponse = this.fOnResponse;}		if (_sResponseFile == null) {_sResponseFile = this.sAjaxResponseFile;}		var _iIndex = oPGArrays.findEmptyIndex({'axArray': this.axTransactions, 'iMaxIndex': this.iMaxTransactionQueue});		if (_iIndex != -1)		{			this.axTransactions[_iIndex] = [				_sParameters,				_fOnResponse,				_sResponseFile,				null,				_fOnError,				_fOnAbort,				_fOnUploadProgress			];			return _iIndex;		}		return -1;	}	/* @end method */	/*	@start method	@description	[en]...[/en]	@return bSuccess [type]bool[/type]	[en]...[/en]	@param iTransactionIndex [needed][type]int[/type	[en]...[/en]	*/	this.deleteTransaction = function(_iTransactionIndex)	{		_iTransactionIndex = this.getRealParameter({'oParameters': _iTransactionIndex, 'sName': 'iTransactionIndex', 'xParameter': _iTransactionIndex});		if ((_iTransactionIndex < this.axTransactions.length) && (_iTransactionIndex > -1))		{			if (this.axTransactions[_iTransactionIndex] != null)			{				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_PARAMETERS] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_FUNCTION] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_XML_FILE] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_UPLOAD_PROGRESS] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ERROR_FUNCTION] = null;				this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ABORT_FUNCTION] = null;				this.axTransactions[_iTransactionIndex] = null;			}			return true;		}		return false;	}	/* @end method */	/*	@start method	@description	[en]...[/en]	@return bSuccess [type]bool[/type]	[en]...[/en]	@param sParameters [type]string[/type]	[en]...[/en]	@param fOnResponse [type]function[/type]	[en]...[/en]	@param sResponseFile [type]string[/type]	[en]...[/en]	*/	this.send = function(_xParameters, _fOnResponse, _sResponseFile, _fOnError, _fOnAbort, _fOnUploadProgress, _oFormData)	{		if (typeof(_xParameters) == 'undefined') {var _xParameters = null;}		if (typeof(_fOnResponse) == 'undefined') {var _fOnResponse = null;}		if (typeof(_sResponseFile) == 'undefined') {var _sResponseFile = null;}		if (typeof(_fOnError) == 'undefined') {var _fOnError = null;}		if (typeof(_fOnAbort) == 'undefined') {var _fOnAbort = null;}		if (typeof(_fOnUploadProgress) == 'undefined') {var _fOnUploadProgress = null;}		if (typeof(_oFormData) == 'undefined') {var _oFormData = null;}		_fOnResponse = this.getRealParameter({'oParameters': _xParameters, 'sName': 'fOnResponse', 'xParameter': _fOnResponse});		_sResponseFile = this.getRealParameter({'oParameters': _xParameters, 'sName': 'sResponseFile', 'xParameter': _sResponseFile});		_fOnError = this.getRealParameter({'oParameters': _xParameters, 'sName': 'fOnError', 'xParameter': _fOnError});		_fOnAbort = this.getRealParameter({'oParameters': _xParameters, 'sName': 'fOnAbort', 'xParameter': _fOnAbort});		_fOnUploadProgress = this.getRealParameter({'oParameters': _xParameters, 'sName': 'fOnUploadProgress', 'xParameter': _fOnUploadProgress});		_oFormData = this.getRealParameter({'oParameters': _xParameters, 'sName': 'oFormData', 'xParameter': _oFormData});		_xParameters = this.getRealParameter({'oParameters': _xParameters, 'sName': 'xParameters', 'xParameter': _xParameters});		if (_xParameters == null) {_xParameters = '';}		if (_fOnResponse == null) {_fOnResponse = this.fOnResponse;}		if (_sResponseFile == null) {_sResponseFile = this.sAjaxResponseFile;}		var _iTransactionIndex = this.registerTransaction(			{				'xParameters': _xParameters,				'fOnResponse': _fOnResponse,				'sResponseFile': _sResponseFile,				'fOnError': _fOnError,				'fOnAbort': _fOnAbort,				'fOnUploadProgress': _fOnUploadProgress			}		);		if (_iTransactionIndex != -1)		{			if (_oFormData == null) {_oFormData = new FormData();}			if (typeof(_xParameters) == 'string')			{				var _asParameters2 = null;				var _asParameters = _xParameters.split('&');				for (var i=0; i<_asParameters.length; i++)				{					_asParameters2 = _asParameters[i].split('=');					_oFormData.append(_asParameters2[0], _asParameters2[1]);				}			}			else if (typeof(_xParameters) == 'object')			{				for (var _sProperty in _xParameters) {_oFormData.append(_sProperty, _xParameters[_sProperty]);}			}			_oFormData.append('iPGNetID', _iTransactionIndex);			if (typeof(_sParameters) == 'string')			{				var _oParameters2 = null;				if (typeof(_sParameters) == 'string')				{					_oParameters2 = oPGStrings.toObject(						{							'sString':_sParameters,							'sParameterSeperator': '=',							'sValueSeperator': '&'						}					);				}				for (var _sProperty in _oParameters2) {_oFormData.append(_sProperty, _xParameters[_sProperty]);}			}            else if (typeof(_sParameters) == 'object') {_oFormData.append('sPGJson', encodeURIComponent(JSON.stringify(_sParameters)));}			if (this.bUseWebSockets)			{				_oFormData.append('iPGNetWebSockets', 1);				// _xParameters += '&iPGNetWebSockets=1';				// this.oWebSockets.setResponseFunction(function (_iTransactionIndex) {oPGNetwork.responseFunction(_iTransactionIndex);});				// this.oWebSockets.send(_sParameters2);				// return true;			}			else			{				_oFormData.append('iPGNetWebSockets', 0);				// _sParameters2 += '&iPGNetWebSockets=0';				if ((this.oAjax == null) && (typeof(oPGAjax) != 'undefined')) {this.oAjax = oPGAjax;}				if (this.oAjax != null)				{					/*					var _oRequestOptions = {};					_oRequestOptions['sResponseFile'] = _sResponseFile;					_oRequestOptions['fResult'] = function (_oEvent) {oPGNetwork.responseFunction(_oEvent, _iTransactionIndex);};					_oRequestOptions['fOnError'] = function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ERROR_FUNCTION, _oEvent, _iTransactionIndex);};					_oRequestOptions['fOnAbort'] = function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ABORT_FUNCTION, _oEvent, _iTransactionIndex);};					_oRequestOptions['fOnUploadProgress'] = function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_UPLOAD_PROGRESS, _oEvent, _iTransactionIndex);};					*/					this.oAjax.closeRequest({'oAjaxRequest': this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT]});					this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_PARAMETERS] = _xParameters;					this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT] = this.oAjax.openRequest(						{							'sResponseFile': _sResponseFile,							'fResult': function (_oEvent) {oPGNetwork.responseFunction(_oEvent, _iTransactionIndex);},							'fOnError': function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ERROR_FUNCTION, _oEvent, _iTransactionIndex);},							'fOnAbort': function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_ABORT_FUNCTION, _oEvent, _iTransactionIndex);},							'fOnUploadProgress': function(_oEvent) {oPGNetwork.eventFunction(PG_NETWORK_TRANSACTION_INDEX_RESPONSE_UPLOAD_PROGRESS, _oEvent, _iTransactionIndex);}						}					);					if (this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT]) {this.oAjax.sendRequest({'oAjaxRequest': this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT], 'xParameters': _oFormData}); return true;}				}			}		}		else {console.log('error on network transaction: buffer overrun!');}		return false;	}	/* @end method */	/*	@start method	@description	[en]...[/en]	@param eEvent [needed][type]object[/type]	[en]...[/en]	@param iTransactionIndex [needed][type]int[/type]	[en]...[/en]	*/	this.responseFunction = function(_eEvent, _iTransactionIndex)	{		if (typeof(_iTransactionIndex) == 'undefined') {var _iTransactionIndex = null;}		_iTransactionIndex = this.getRealParameter({'oParameters': _iTransactionIndex, 'sName': 'iTransactionIndex', 'xParameter': _iTransactionIndex});		var _sParameters = '';		if (_sParameters = oPGNetwork.getResponseParameters({'iTransactionIndex': _iTransactionIndex}))		{			if (this.axTransactions[_iTransactionIndex])			{				if (typeof(_sParameters) == 'object')				{					if (typeof(_sParameters['sPGError']) != 'undefined') {if (_sParameters['sPGError'] != '') {console.log(_sParameters['sPGError']);}}					this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_FUNCTION](_sParameters);				}				// else if ((typeof(_sParameters == 'string')) && (this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT].sResponseType == PG_AJAX_RESPONSETYPE_JSON)) {this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_FUNCTION](JSON.parse(_sParameters));}				else {this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_RESPONSE_FUNCTION](oPGStrings.toObject({'sString': _sParameters, 'sParameterSeperator': '&_[', 'sValueSeperator': ']_='}));}			}			this.deleteTransaction({'iTransactionIndex': _iTransactionIndex});		}	}	/* @end method */	this.eventFunction = function(_iEventIndex, _oEvent, _iTransactionIndex)	{		if (!this.axTransactions[_iTransactionIndex]) {return;}		var _oParameters = this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_PARAMETERS];		if (this.axTransactions[_iTransactionIndex][_iEventIndex] != null)		{			this.axTransactions[_iTransactionIndex][_iEventIndex](_oEvent, _oParameters, _iTransactionIndex);		}	}	/*	@start method	@description	[en]...[/en]	@return sParameters [type]string[/type]	[en]...[/en]	@param iTransactionIndex [needed][type]int[/type]	[en]...[/en]	*/	this.getResponseParameters = function(_iTransactionIndex)	{		if (typeof(_iTransactionIndex) == 'undefined') {var _iTransactionIndex = null;}		_iTransactionIndex = this.getRealParameter({'oParameters': _iTransactionIndex, 'sName': 'iTransactionIndex', 'xParameter': _iTransactionIndex});		if (this.axTransactions[_iTransactionIndex] != null)		{			if (this.bUseWebSockets)			{				console.log('todo WebSockets!');			}			else			{				var _oAjaxRequest = this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT];				if (_oAjaxRequest != null)				{                    var _oXml = this.oAjax.getResultXmlObject({'oAjaxRequest': _oAjaxRequest});                    if (_oXml == null) {console.log('Network Error: Xml is null!');}                    else if ((typeof(_oXml) == 'object') && (typeof(_oXml['tagName']) != 'undefined'))                    {                        var _sParameters = this.oAjax.getResultAll({'oXml': _oXml});                        this.close({'iTransactionIndex': _iTransactionIndex});                        return _sParameters;                    }					else if (typeof(_oXml) == 'string')                    {                        // if (this.oAjax.sContentType == PG_AJAX_CONTENTTYPE_JSON)                        if (this.oAjax.sResponseType == PG_AJAX_RESPONSETYPE_JSON)                        {                            this.close({'iTransactionIndex': _iTransactionIndex});                            // alert(_oXml);                            return JSON.parse(_oXml);                        }                        else {console.log("Network Error:\n"+_oXml);}                    }					else if (typeof(_oXml) == 'object')               		{                        return _oXml;					}					// else {alert('Unknown Network Error!');}				}				// else {alert('Network Transactions Error!');}			}		}		return false;	}	/* @end method */	/*	@start method	@description	[en]...[/en]	@param iTransactionIndex [needed][type]int[/type]	[en]...[/en]	*/	this.close = function(_iTransactionIndex)	{		if (typeof(_iTransactionIndex) == 'undefined') {var _iTransactionIndex = null;}		_iTransactionIndex = this.getRealParameter({'oParameters': _iTransactionIndex, 'sName': 'iTransactionIndex', 'xParameter': _iTransactionIndex});		if (this.bUseWebSockets)		{			// this.oWebSockets.close();		}		else {this.oAjax.closeRequest({'oAjaxRequest': this.axTransactions[_iTransactionIndex][PG_NETWORK_TRANSACTION_INDEX_AJAX_REQUEST_OBJECT]});}	}	/* @end method */}/* @end class */classPG_Network.prototype = new classPG_ClassBasics();var oPGNetwork = new classPG_Network();